<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Shop - Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@300;400;500;600;700&display=swap');

        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --dark-gradient: linear-gradient(135deg, #0c0c0c 0%, #161b22 50%, #21262d 100%);
            --glass-bg: rgba(255, 255, 255, 0.02);
            --glass-border: rgba(255, 255, 255, 0.05);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            --accent-blue: #58a6ff;
            --accent-purple: #a5a3ff;
            --accent-pink: #ff7eb6;
            --danger: #f85149;
            --success: #3fb950;
            --warning: #d29922;
            --border-subtle: rgba(240, 246, 252, 0.05);
            --surface-1: rgba(13, 17, 23, 0.8);
            --surface-2: rgba(22, 27, 34, 0.6);
            --surface-3: rgba(33, 38, 45, 0.4);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 400;
            background: #000000;
            color: var(--text-primary);
            overflow-x: hidden;
            line-height: 1.6;
            font-size: 15px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            position: relative;
            font-feature-settings: 'kern' 1, 'liga' 1;
            letter-spacing: -0.011em;
        }

        /* Revolutionary Premium Background */
        .premium-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -3;
            background: 
                radial-gradient(ellipse 120% 80% at 50% 0%, rgba(102, 126, 234, 0.08) 0%, transparent 60%),
                radial-gradient(ellipse 100% 60% at 80% 100%, rgba(118, 75, 162, 0.06) 0%, transparent 50%),
                radial-gradient(ellipse 80% 100% at 20% 100%, rgba(88, 166, 255, 0.04) 0%, transparent 40%),
                linear-gradient(180deg, #000000 0%, #0a0a0a 30%, #0d1117 60%, #161b22 100%);
            background-attachment: fixed;
        }

        .premium-background::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle 400px at 20% 20%, rgba(102, 126, 234, 0.15) 0%, transparent 60%),
                radial-gradient(circle 300px at 80% 80%, rgba(118, 75, 162, 0.12) 0%, transparent 50%),
                radial-gradient(circle 500px at 50% 50%, rgba(88, 166, 255, 0.08) 0%, transparent 70%),
                radial-gradient(circle 200px at 10% 90%, rgba(240, 147, 251, 0.1) 0%, transparent 40%);
            animation: premiumOrbs 40s ease-in-out infinite;
            filter: blur(1px);
        }

        .premium-background::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(90deg, transparent 98%, rgba(102, 126, 234, 0.02) 100%),
                linear-gradient(0deg, transparent 98%, rgba(88, 166, 255, 0.02) 100%),
                repeating-linear-gradient(
                    90deg,
                    transparent,
                    transparent 98px,
                    rgba(240, 246, 252, 0.005) 100px
                ),
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 98px,
                    rgba(240, 246, 252, 0.005) 100px
                );
            background-size: 100px 100px, 100px 100px, 100px 100px, 100px 100px;
            animation: premiumGrid 120s linear infinite;
            opacity: 0.3;
        }

        /* Neural Network Effect */
        .neural-network {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            pointer-events: none;
            background: 
                radial-gradient(circle 2px at 10% 20%, rgba(102, 126, 234, 0.4) 0%, transparent 50%),
                radial-gradient(circle 1px at 90% 30%, rgba(88, 166, 255, 0.3) 0%, transparent 50%),
                radial-gradient(circle 1px at 30% 80%, rgba(165, 163, 255, 0.3) 0%, transparent 50%),
                radial-gradient(circle 2px at 70% 70%, rgba(118, 75, 162, 0.4) 0%, transparent 50%),
                radial-gradient(circle 1px at 50% 10%, rgba(255, 126, 182, 0.3) 0%, transparent 50%);
            animation: neuralPulse 8s ease-in-out infinite;
        }

        @keyframes premiumOrbs {
            0%, 100% { 
                transform: translate(0, 0) scale(1) rotate(0deg);
                opacity: 0.6;
            }
            25% { 
                transform: translate(30px, -20px) scale(1.1) rotate(90deg);
                opacity: 0.8;
            }
            50% { 
                transform: translate(-20px, 30px) scale(0.9) rotate(180deg);
                opacity: 0.7;
            }
            75% { 
                transform: translate(25px, 15px) scale(1.05) rotate(270deg);
                opacity: 0.9;
            }
        }

        @keyframes premiumGrid {
            0% { 
                transform: translate(0, 0) rotate(0deg);
                opacity: 0.3;
            }
            50% { 
                transform: translate(50px, 50px) rotate(0.5deg);
                opacity: 0.5;
            }
            100% { 
                transform: translate(100px, 100px) rotate(1deg);
                opacity: 0.3;
            }
        }

        @keyframes neuralPulse {
            0%, 100% { 
                opacity: 0.6;
                transform: scale(1);
                filter: brightness(1);
            }
            25% { 
                opacity: 0.8;
                transform: scale(1.02);
                filter: brightness(1.1);
            }
            50% { 
                opacity: 0.9;
                transform: scale(1.01);
                filter: brightness(1.2);
            }
            75% { 
                opacity: 0.7;
                transform: scale(1.03);
                filter: brightness(1.05);
            }
        }

        /* Floating Particles */
        .floating-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: rgba(33, 38, 45, 0.8);
            border-radius: 1px;
            animation: digitalFloat 20s linear infinite;
            opacity: 0;
            box-shadow: 0 0 2px rgba(33, 38, 45, 0.5);
        }

        @keyframes digitalFloat {
            0% {
                opacity: 0;
                transform: translateY(100vh) translateX(0) scale(0);
            }
            5% {
                opacity: 0.6;
                transform: translateY(95vh) translateX(5px) scale(1);
            }
            95% {
                opacity: 0.6;
                transform: translateY(5vh) translateX(-5px) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(0) translateX(0) scale(0);
            }
        }

        /* Floating Brand Elements */
        .floating-brands {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }

        .brand-logo {
            position: absolute;
            font-size: 20px;
            opacity: 0.3;
            animation: techFloat 12s ease-in-out infinite;
            filter: drop-shadow(0 0 4px rgba(33, 38, 45, 0.8));
            color: rgba(139, 148, 158, 0.6);
        }

        @keyframes techFloat {
            0%, 100% {
                transform: translateY(0) rotate(0deg) scale(1);
                opacity: 0.3;
            }
            25% {
                transform: translateY(-10px) rotate(2deg) scale(1.02);
                opacity: 0.5;
            }
            50% {
                transform: translateY(-5px) rotate(-2deg) scale(0.98);
                opacity: 0.4;
            }
            75% {
                transform: translateY(-12px) rotate(1deg) scale(1.01);
                opacity: 0.45;
            }
        }

        /* Premium Ripple Effect */
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
            transform: scale(0);
            animation: rippleEffect 0.6s ease-out;
            pointer-events: none;
        }

        @keyframes rippleEffect {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        .app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            backdrop-filter: blur(0.5px);
        }

        .header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: 
                linear-gradient(135deg, var(--glass-bg) 0%, rgba(22, 27, 34, 0.02) 100%),
                linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.03) 100%);
            backdrop-filter: blur(40px) saturate(1.2);
            -webkit-backdrop-filter: blur(40px) saturate(1.2);
            border: 1px solid var(--glass-border);
            border-bottom: 1px solid rgba(102, 126, 234, 0.1);
            padding: 24px 20px 20px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                0 1px 0 rgba(102, 126, 234, 0.1) inset,
                0 -1px 0 rgba(0, 0, 0, 0.2) inset;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            position: relative;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 800;
            position: relative;
            letter-spacing: -0.02em;
            background: linear-gradient(135deg, #f0f6fc 0%, #c9d1d9 50%, #8b949e 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 12px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        .header h1::before {
            content: '◆';
            position: static;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 28px;
            animation: premiumPulse 4s ease-in-out infinite;
            filter: drop-shadow(0 0 8px rgba(102, 126, 234, 0.3));
        }

        .header h1::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent 30%, rgba(102, 126, 234, 0.1) 50%, transparent 70%);
            transform: translate(-50%, -50%) skewX(-45deg);
            animation: shimmer 3s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes balanceShine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @keyframes techPulse {
            0%, 100% { 
                opacity: 0.7;
                transform: translateY(-50%) scale(1);
            }
            50% { 
                opacity: 1;
                transform: translateY(-50%) scale(1.1);
            }
        }

        .balance {
            background: 
                linear-gradient(135deg, var(--glass-bg) 0%, rgba(13, 17, 23, 0.1) 100%),
                linear-gradient(135deg, rgba(88, 166, 255, 0.08) 0%, rgba(102, 126, 234, 0.05) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(88, 166, 255, 0.2);
            color: var(--accent-blue);
            padding: 16px 20px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 16px;
            box-shadow: 
                0 4px 20px rgba(88, 166, 255, 0.1),
                0 1px 0 rgba(88, 166, 255, 0.1) inset;
            position: relative;
            font-family: 'JetBrains Mono', 'SF Mono', 'Monaco', monospace;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: 0.02em;
            min-width: 140px;
            text-align: center;
        }

        .balance:hover {
            transform: translateY(-2px) scale(1.02);
            border-color: rgba(88, 166, 255, 0.4);
            box-shadow: 
                0 8px 30px rgba(88, 166, 255, 0.2),
                0 1px 0 rgba(88, 166, 255, 0.2) inset;
            background: 
                linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(13, 17, 23, 0.1) 100%),
                linear-gradient(135deg, rgba(88, 166, 255, 0.12) 0%, rgba(102, 126, 234, 0.08) 100%);
        }

        .balance::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(88, 166, 255, 0.2), transparent);
            animation: balanceShine 4s ease-in-out infinite;
            border-radius: 12px;
        }

        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 4px;
            margin-bottom: 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tab {
            flex: 1;
            padding: 12px 16px;
            text-align: center;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 14px;
            position: relative;
            overflow: hidden;
        }

        .tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--tg-theme-button-color, #007aff) 0%, #0056cc 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
            border-radius: 12px;
        }

        .tab.active::before {
            opacity: 1;
        }

        .tab span {
            position: relative;
            z-index: 1;
        }

        .tab.active {
            color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.4);
        }

        .content {
            flex: 1;
            padding: 20px;
        }

        .selector-group {
            margin-bottom: 24px;
        }

        .selector {
            position: relative;
            margin-bottom: 16px;
        }

        .selector select {
            width: 100%;
            padding: 16px 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--tg-theme-text-color, #ffffff);
            font-size: 16px;
            font-weight: 500;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            appearance: none;
            cursor: pointer;
        }

        .selector select:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #007aff);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
            background: rgba(255, 255, 255, 0.08);
        }

        .selector::after {
            content: '▼';
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: var(--tg-theme-hint-color, #8e8e93);
            font-size: 12px;
        }

        /* New button-based selection styles */
        .selection-step {
            margin-bottom: 24px;
        }

        .step-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
            background: linear-gradient(135deg, #ffffff 0%, #a0a0a0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .step-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            position: relative;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--tg-theme-text-color, #ffffff);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(-2px);
        }

        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .location-btn {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.02) 100%);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: #ffffff;
            padding: 24px 28px;
            border-radius: 20px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(20px);
            text-align: left;
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .location-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(120, 119, 198, 0.2) 0%, 
                rgba(255, 119, 198, 0.15) 50%,
                rgba(120, 219, 255, 0.2) 100%);
            opacity: 0;
            transition: all 0.4s ease;
            z-index: -1;
        }

        .location-btn::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: translate(-100%, -100%) rotate(45deg);
            transition: transform 0.6s ease;
        }

        .location-btn:hover::before {
            opacity: 1;
        }

        .location-btn:hover::after {
            transform: translate(100%, 100%) rotate(45deg);
        }

        .location-btn:hover {
            border-color: rgba(139, 148, 158, 0.4);
            transform: translateY(-2px) scale(1.01);
            box-shadow: 
                0 8px 20px rgba(0, 0, 0, 0.5),
                0 0 0 1px rgba(139, 148, 158, 0.2),
                inset 0 1px 0 rgba(139, 148, 158, 0.15);
        }

        .location-btn:active {
            transform: translateY(-2px) scale(1.01);
        }

        .location-info {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            margin-bottom: 16px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        /* Payment Modal Styles */
        .payment-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(10px);
        }

        .payment-modal-content {
            background: linear-gradient(135deg, #21262d 0%, #161b22 100%);
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid #30363d;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
        }

        .payment-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #30363d;
        }

        .payment-modal-header h3 {
            margin: 0;
            color: #f0f6fc;
            font-size: 18px;
        }

        .close-modal {
            background: none;
            border: none;
            color: #8b949e;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .close-modal:hover {
            background: rgba(139, 148, 158, 0.1);
            color: #f0f6fc;
        }

        .currency-list {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .currency-btn {
            background: linear-gradient(135deg, rgba(33, 38, 45, 0.5) 0%, rgba(22, 27, 34, 0.5) 100%);
            border: 1px solid #30363d;
            color: #f0f6fc;
            padding: 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            text-align: left;
        }

        .currency-btn:hover {
            border-color: #8b949e;
            background: linear-gradient(135deg, rgba(33, 38, 45, 0.8) 0%, rgba(22, 27, 34, 0.8) 100%);
            transform: translateY(-2px);
        }

        .currency-symbol {
            font-weight: bold;
            font-size: 16px;
            color: #58a6ff;
            min-width: 60px;
        }

        .currency-name {
            flex: 1;
            font-size: 14px;
        }

        .currency-network {
            font-size: 12px;
            color: #8b949e;
            background: rgba(139, 148, 158, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
        }

        .invoice-content {
            padding: 20px;
        }

        .invoice-section {
            margin-bottom: 24px;
        }

        .invoice-section h4 {
            color: #f0f6fc;
            margin-bottom: 12px;
            font-size: 16px;
        }

        .payment-info {
            background: rgba(13, 17, 23, 0.6);
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #21262d;
        }

        .payment-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(48, 54, 61, 0.3);
        }

        .payment-row:last-child {
            border-bottom: none;
        }

        .payment-row span:first-child {
            color: #8b949e;
            font-size: 14px;
        }

        .payment-row span:last-child {
            color: #f0f6fc;
            font-weight: 600;
        }

        .payment-amount {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            color: #58a6ff !important;
        }

        .payment-id {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 12px !important;
        }

        .wallet-address-container {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(13, 17, 23, 0.6);
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #21262d;
        }

        .wallet-address {
            flex: 1;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 14px;
            color: #58a6ff;
            word-break: break-all;
            background: rgba(88, 166, 255, 0.1);
            padding: 8px;
            border-radius: 4px;
        }

        .copy-btn {
            background: linear-gradient(135deg, #21262d 0%, #161b22 100%);
            border: 1px solid #30363d;
            color: #f0f6fc;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .copy-btn:hover {
            border-color: #8b949e;
            background: linear-gradient(135deg, #30363d 0%, #21262d 100%);
        }

        .payment-instructions {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            padding: 16px;
        }

        .payment-instructions h4 {
            color: #ffc107;
            margin-bottom: 12px;
        }

        .payment-instructions ul {
            margin: 0;
            padding-left: 20px;
            color: #f0f6fc;
        }

        .payment-instructions li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        @media (max-width: 480px) {
            .button-grid {
                grid-template-columns: 1fr;
            }
            
            .step-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            
            .step-title {
                font-size: 18px;
            }

            .payment-modal-content {
                width: 95%;
                max-height: 90vh;
            }

            .wallet-address-container {
                flex-direction: column;
                align-items: stretch;
            }

            .currency-btn {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .product-card {
            background: 
                linear-gradient(135deg, var(--glass-bg) 0%, rgba(22, 27, 34, 0.05) 100%),
                linear-gradient(135deg, rgba(102, 126, 234, 0.03) 0%, rgba(118, 75, 162, 0.02) 100%);
            backdrop-filter: blur(20px) saturate(1.1);
            -webkit-backdrop-filter: blur(20px) saturate(1.1);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                0 1px 0 rgba(102, 126, 234, 0.05) inset,
                0 -1px 0 rgba(0, 0, 0, 0.1) inset;
            cursor: pointer;
        }

        .product-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(33, 38, 45, 0.8) 0%, 
                rgba(22, 27, 34, 0.6) 100%);
            opacity: 0;
            transition: all 0.3s ease;
            border-radius: 12px;
        }

        .product-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.05), transparent);
            transform: translate(-100%, -100%) rotate(45deg);
            transition: transform 0.8s ease;
        }

        .product-card:hover::before {
            opacity: 1;
        }

        .product-card:hover::after {
            transform: translate(100%, 100%) rotate(45deg);
        }

        .product-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.4),
                0 1px 0 rgba(102, 126, 234, 0.2) inset,
                0 -1px 0 rgba(0, 0, 0, 0.2) inset;
            border-color: rgba(102, 126, 234, 0.2);
            background: 
                linear-gradient(135deg, rgba(255, 255, 255, 0.03) 0%, rgba(22, 27, 34, 0.08) 100%),
                linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.05) 100%);
        }

        .product-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
            position: relative;
            z-index: 1;
        }

        .product-emoji {
            font-size: 32px;
            margin-right: 16px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .product-title {
            font-size: 20px;
            font-weight: 700;
            color: #ffffff;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .product-info {
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        .product-location {
            color: var(--tg-theme-hint-color, #8e8e93);
            font-size: 14px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .product-price {
            font-size: 24px;
            font-weight: 800;
            background: linear-gradient(135deg, #00d4aa 0%, #00a86b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0, 212, 170, 0.3);
        }

        .product-stock {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #8e8e93);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stock-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00d4aa;
            box-shadow: 0 0 8px rgba(0, 212, 170, 0.5);
        }

        .product-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            position: relative;
            z-index: 1;
        }

        .btn {
            flex: 1;
            padding: 14px 20px;
            border: none;
            border-radius: 16px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.1) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
            border-radius: 16px;
        }

        .btn:hover::before {
            opacity: 1;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--tg-theme-button-color, #007aff) 0%, #0056cc 100%);
            color: #ffffff;
            box-shadow: 0 8px 20px rgba(0, 122, 255, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .basket-fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--tg-theme-button-color, #007aff) 0%, #0056cc 100%);
            color: #ffffff;
            border: none;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 12px 24px rgba(0, 122, 255, 0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: all 0.3s ease;
            backdrop-filter: blur(20px);
        }

        .basket-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 16px 32px rgba(0, 122, 255, 0.5);
        }

        .basket-fab:active {
            transform: scale(0.95);
        }

        .basket-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #ff3b30 0%, #d70015 100%);
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 700;
            box-shadow: 0 4px 8px rgba(255, 59, 48, 0.4);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Premium Loading States */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 80px 20px;
            color: var(--text-secondary);
            font-size: 16px;
            font-weight: 500;
            gap: 24px;
            text-align: center;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--surface-2);
            border-top: 4px solid var(--accent-blue);
            border-radius: 50%;
            animation: premiumSpin 1.2s cubic-bezier(0.4, 0, 0.2, 1) infinite;
            position: relative;
        }

        .loading-spinner::after {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border: 2px solid transparent;
            border-top: 2px solid var(--accent-purple);
            border-radius: 50%;
            animation: premiumSpin 2s cubic-bezier(0.4, 0, 0.2, 1) infinite reverse;
        }

        .skeleton {
            background: linear-gradient(90deg, 
                var(--surface-2) 25%, 
                var(--surface-3) 50%, 
                var(--surface-2) 75%);
            background-size: 200% 100%;
            animation: shimmerSkeleton 2s infinite;
            border-radius: 8px;
        }

        .skeleton-card {
            background: 
                linear-gradient(135deg, var(--glass-bg) 0%, rgba(22, 27, 34, 0.05) 100%),
                linear-gradient(135deg, rgba(102, 126, 234, 0.03) 0%, rgba(118, 75, 162, 0.02) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
        }

        .skeleton-line {
            height: 20px;
            margin-bottom: 12px;
        }

        .skeleton-line.short { width: 60%; }
        .skeleton-line.medium { width: 80%; }
        .skeleton-line.long { width: 100%; }

        @keyframes premiumSpin {
            0% { 
                transform: rotate(0deg);
                filter: hue-rotate(0deg);
            }
            100% { 
                transform: rotate(360deg);
                filter: hue-rotate(360deg);
            }
        }

        @keyframes shimmerSkeleton {
            0% { 
                background-position: -200% 0;
                opacity: 0.6;
            }
            50% {
                opacity: 0.8;
            }
            100% { 
                background-position: 200% 0;
                opacity: 0.6;
            }
        }

        /* 3D Animated City Icons - 4 DIFFERENT STYLES */
        
        /* ===== STYLE 1: MODERN SKYSCRAPER CITY ===== */
        .city-icon-3d-style1 {
            width: 48px;
            height: 48px;
            position: relative;
            transform-style: preserve-3d;
            animation: cityFloat 6s ease-in-out infinite;
            flex-shrink: 0;
        }

        .city-building-style1 {
            position: absolute;
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%);
            border-radius: 2px;
            transform-origin: bottom center;
            animation: buildingPulse 4s ease-in-out infinite;
            box-shadow: 
                0 4px 8px rgba(88, 166, 255, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .city-building-style1:nth-child(1) {
            width: 8px;
            height: 24px;
            left: 4px;
            bottom: 0;
            animation-delay: 0s;
        }

        .city-building-style1:nth-child(2) {
            width: 12px;
            height: 32px;
            left: 14px;
            bottom: 0;
            animation-delay: 0.5s;
            background: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-pink) 100%);
        }

        .city-building-style1:nth-child(3) {
            width: 10px;
            height: 28px;
            left: 28px;
            bottom: 0;
            animation-delay: 1s;
        }

        .city-building-style1:nth-child(4) {
            width: 6px;
            height: 20px;
            left: 40px;
            bottom: 0;
            animation-delay: 1.5s;
            background: linear-gradient(135deg, var(--accent-pink) 0%, var(--accent-blue) 100%);
        }

        /* ===== STYLE 2: CYBERPUNK NEON CITY ===== */
        .city-icon-3d-style2 {
            width: 48px;
            height: 48px;
            position: relative;
            transform-style: preserve-3d;
            animation: cyberFloat 4s ease-in-out infinite;
            flex-shrink: 0;
        }

        .city-building-style2 {
            position: absolute;
            background: linear-gradient(180deg, #00ff88 0%, #0088ff 50%, #ff0088 100%);
            border-radius: 1px;
            transform-origin: bottom center;
            animation: cyberPulse 2s ease-in-out infinite;
            box-shadow: 
                0 0 8px currentColor,
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .city-building-style2:nth-child(1) {
            width: 6px;
            height: 36px;
            left: 6px;
            bottom: 0;
            animation-delay: 0s;
            color: #00ff88;
        }

        .city-building-style2:nth-child(2) {
            width: 8px;
            height: 42px;
            left: 16px;
            bottom: 0;
            animation-delay: 0.3s;
            color: #0088ff;
        }

        .city-building-style2:nth-child(3) {
            width: 10px;
            height: 38px;
            left: 28px;
            bottom: 0;
            animation-delay: 0.6s;
            color: #ff0088;
        }

        .city-building-style2:nth-child(4) {
            width: 7px;
            height: 32px;
            left: 42px;
            bottom: 0;
            animation-delay: 0.9s;
            color: #ffff00;
        }

        /* ===== STYLE 3: MINIMALIST GEOMETRIC CITY ===== */
        .city-icon-3d-style3 {
            width: 48px;
            height: 48px;
            position: relative;
            transform-style: preserve-3d;
            animation: minimalFloat 8s ease-in-out infinite;
            flex-shrink: 0;
        }

        .city-building-style3 {
            position: absolute;
            background: var(--accent-blue);
            border-radius: 0;
            transform-origin: bottom center;
            animation: minimalPulse 6s ease-in-out infinite;
            box-shadow: 
                0 2px 4px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .city-building-style3:nth-child(1) {
            width: 10px;
            height: 20px;
            left: 8px;
            bottom: 0;
            animation-delay: 0s;
        }

        .city-building-style3:nth-child(2) {
            width: 14px;
            height: 28px;
            left: 20px;
            bottom: 0;
            animation-delay: 1.5s;
        }

        .city-building-style3:nth-child(3) {
            width: 12px;
            height: 24px;
            left: 36px;
            bottom: 0;
            animation-delay: 3s;
        }

        /* ===== STYLE 4: FANTASY CRYSTAL CITY ===== */
        .city-icon-3d-style4 {
            width: 48px;
            height: 48px;
            position: relative;
            transform-style: preserve-3d;
            animation: crystalFloat 5s ease-in-out infinite;
            flex-shrink: 0;
        }

        .city-building-style4 {
            position: absolute;
            background: linear-gradient(45deg, 
                rgba(255, 255, 255, 0.9) 0%, 
                rgba(88, 166, 255, 0.8) 25%, 
                rgba(255, 119, 198, 0.8) 50%, 
                rgba(255, 255, 255, 0.9) 100%);
            border-radius: 50% 50% 0 0;
            transform-origin: bottom center;
            animation: crystalPulse 3s ease-in-out infinite;
            box-shadow: 
                0 0 12px rgba(255, 255, 255, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(2px);
        }

        .city-building-style4:nth-child(1) {
            width: 12px;
            height: 26px;
            left: 6px;
            bottom: 0;
            animation-delay: 0s;
        }

        .city-building-style4:nth-child(2) {
            width: 16px;
            height: 34px;
            left: 20px;
            bottom: 0;
            animation-delay: 0.7s;
        }

        .city-building-style4:nth-child(3) {
            width: 14px;
            height: 30px;
            left: 38px;
            bottom: 0;
            animation-delay: 1.4s;
        }

        /* Building windows for Style 1 */
        .city-building-style1::before {
            content: '';
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 2px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 1px;
            box-shadow: 
                0 4px 0 rgba(255, 255, 255, 0.6),
                0 8px 0 rgba(255, 255, 255, 0.4),
                0 12px 0 rgba(255, 255, 255, 0.6);
            animation: windowGlow 3s ease-in-out infinite;
        }

        /* Neon glow for Style 2 */
        .city-building-style2::before {
            content: '';
            position: absolute;
            top: 15%;
            left: 50%;
            transform: translateX(-50%);
            width: 1px;
            height: 1px;
            background: currentColor;
            border-radius: 50%;
            box-shadow: 
                0 3px 0 currentColor,
                0 6px 0 currentColor,
                0 9px 0 currentColor,
                0 12px 0 currentColor;
            animation: neonGlow 1.5s ease-in-out infinite;
        }

        /* Floating effect around city */
        .city-icon-3d-style1::after,
        .city-icon-3d-style2::after,
        .city-icon-3d-style3::after,
        .city-icon-3d-style4::after {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border-radius: 50%;
            z-index: -1;
        }

        .city-icon-3d-style1::after {
            background: radial-gradient(circle, rgba(88, 166, 255, 0.2) 0%, transparent 70%);
            animation: cityGlow 4s ease-in-out infinite;
        }

        .city-icon-3d-style2::after {
            background: radial-gradient(circle, rgba(0, 255, 136, 0.3) 0%, transparent 70%);
            animation: cyberGlow 2s ease-in-out infinite;
        }

        .city-icon-3d-style3::after {
            background: radial-gradient(circle, rgba(88, 166, 255, 0.1) 0%, transparent 70%);
            animation: minimalGlow 8s ease-in-out infinite;
        }

        .city-icon-3d-style4::after {
            background: radial-gradient(circle, rgba(255, 255, 255, 0.2) 0%, transparent 70%);
            animation: crystalGlow 5s ease-in-out infinite;
        }

        /* ===== ANIMATIONS FOR ALL STYLES ===== */
        
        /* Style 1: Modern Skyscraper */
        @keyframes cityFloat {
            0%, 100% { 
                transform: translateY(0) rotateY(0deg) scale(1);
            }
            25% { 
                transform: translateY(-3px) rotateY(5deg) scale(1.02);
            }
            50% { 
                transform: translateY(-2px) rotateY(0deg) scale(1.05);
            }
            75% { 
                transform: translateY(-4px) rotateY(-5deg) scale(1.02);
            }
        }

        @keyframes buildingPulse {
            0%, 100% { 
                transform: scaleY(1) rotateZ(0deg);
                opacity: 0.8;
            }
            25% { 
                transform: scaleY(1.1) rotateZ(1deg);
                opacity: 1;
            }
            50% { 
                transform: scaleY(0.95) rotateZ(0deg);
                opacity: 0.9;
            }
            75% { 
                transform: scaleY(1.05) rotateZ(-1deg);
                opacity: 1;
            }
        }

        /* Style 2: Cyberpunk */
        @keyframes cyberFloat {
            0%, 100% { 
                transform: translateY(0) rotateX(0deg) scale(1);
            }
            33% { 
                transform: translateY(-4px) rotateX(10deg) scale(1.03);
            }
            66% { 
                transform: translateY(-2px) rotateX(-5deg) scale(1.01);
            }
        }

        @keyframes cyberPulse {
            0%, 100% { 
                transform: scaleY(1) rotateZ(0deg);
                filter: brightness(1);
            }
            50% { 
                transform: scaleY(1.15) rotateZ(2deg);
                filter: brightness(1.5);
            }
        }

        @keyframes neonGlow {
            0%, 100% { 
                opacity: 0.7;
                filter: brightness(1);
            }
            50% { 
                opacity: 1;
                filter: brightness(2);
            }
        }

        /* Style 3: Minimalist */
        @keyframes minimalFloat {
            0%, 100% { 
                transform: translateY(0) rotateY(0deg) scale(1);
            }
            50% { 
                transform: translateY(-2px) rotateY(3deg) scale(1.02);
            }
        }

        @keyframes minimalPulse {
            0%, 100% { 
                transform: scaleY(1);
                opacity: 0.9;
            }
            50% { 
                transform: scaleY(1.05);
                opacity: 1;
            }
        }

        /* Style 4: Fantasy Crystal */
        @keyframes crystalFloat {
            0%, 100% { 
                transform: translateY(0) rotateZ(0deg) scale(1);
            }
            25% { 
                transform: translateY(-3px) rotateZ(5deg) scale(1.03);
            }
            50% { 
                transform: translateY(-1px) rotateZ(0deg) scale(1.05);
            }
            75% { 
                transform: translateY(-4px) rotateZ(-5deg) scale(1.02);
            }
        }

        @keyframes crystalPulse {
            0%, 100% { 
                transform: scaleY(1) rotateZ(0deg);
                opacity: 0.8;
            }
            25% { 
                transform: scaleY(1.1) rotateZ(2deg);
                opacity: 1;
            }
            50% { 
                transform: scaleY(0.95) rotateZ(0deg);
                opacity: 0.9;
            }
            75% { 
                transform: scaleY(1.05) rotateZ(-2deg);
                opacity: 1;
            }
        }

        /* Glow animations */
        @keyframes cityGlow {
            0%, 100% { 
                opacity: 0.3;
                transform: scale(1);
            }
            50% { 
                opacity: 0.6;
                transform: scale(1.1);
            }
        }

        @keyframes cyberGlow {
            0%, 100% { 
                opacity: 0.4;
                transform: scale(1);
            }
            50% { 
                opacity: 0.8;
                transform: scale(1.2);
            }
        }

        @keyframes minimalGlow {
            0%, 100% { 
                opacity: 0.2;
                transform: scale(1);
            }
            50% { 
                opacity: 0.4;
                transform: scale(1.05);
            }
        }

        @keyframes crystalGlow {
            0%, 100% { 
                opacity: 0.3;
                transform: scale(1);
            }
            50% { 
                opacity: 0.7;
                transform: scale(1.15);
            }
        }

        @keyframes windowGlow {
            0%, 100% { 
                opacity: 0.6;
                filter: brightness(1);
            }
            50% { 
                opacity: 1;
                filter: brightness(1.5);
            }
        }

        /* Hover effects for all styles */
        .location-btn:hover .city-icon-3d-style1,
        .location-btn:hover .city-icon-3d-style2,
        .location-btn:hover .city-icon-3d-style3,
        .location-btn:hover .city-icon-3d-style4 {
            animation-duration: 2s;
            transform: translateY(-6px) rotateY(15deg) scale(1.1);
        }

        .location-btn:hover .city-building-style1,
        .location-btn:hover .city-building-style2,
        .location-btn:hover .city-building-style3,
        .location-btn:hover .city-building-style4 {
            animation-duration: 1s;
        }

                 .location-btn:hover .city-icon-3d-style1::after,
         .location-btn:hover .city-icon-3d-style2::after,
         .location-btn:hover .city-icon-3d-style3::after,
         .location-btn:hover .city-icon-3d-style4::after {
             opacity: 0.8;
             transform: scale(1.3);
         }

         /* Location pin animation */
         @keyframes pinPulse {
             0%, 100% { 
                 transform: rotate(-45deg) scale(1);
                 opacity: 1;
             }
             50% { 
                 transform: rotate(-45deg) scale(1.1);
                 opacity: 0.8;
             }
         }

         .error {
             text-align: center;
             padding: 24px;
             color: #ff3b30;
             background: rgba(255, 59, 48, 0.1);
             border: 1px solid rgba(255, 59, 48, 0.2);
             border-radius: 16px;
             margin: 20px 0;
             backdrop-filter: blur(10px);
         }

         .empty-state {
             text-align: center;
             padding: 60px 20px;
             color: var(--tg-theme-hint-color, #8e8e93);
         }

         .empty-state-emoji {
             font-size: 64px;
             margin-bottom: 20px;
             filter: grayscale(50%);
         }

         .empty-state h3 {
             font-size: 20px;
             font-weight: 600;
             margin-bottom: 8px;
             color: #ffffff;
         }

         .empty-state p {
             font-size: 16px;
             opacity: 0.7;
         }

         .tab-content {
             display: none;
         }

         .tab-content.active {
             display: block;
         }

         .profile-card {
             background: rgba(255, 255, 255, 0.05);
             border-radius: 20px;
             padding: 24px;
             border: 1px solid rgba(255, 255, 255, 0.1);
             backdrop-filter: blur(20px);
             margin-bottom: 20px;
         }

         .profile-avatar {
             width: 80px;
             height: 80px;
             border-radius: 50%;
             background: linear-gradient(135deg, var(--tg-theme-button-color, #007aff) 0%, #0056cc 100%);
             display: flex;
             align-items: center;
             justify-content: center;
             font-size: 32px;
             color: white;
             margin: 0 auto 20px;
             box-shadow: 0 8px 20px rgba(0, 122, 255, 0.3);
         }

         .profile-info {
             text-align: center;
         }

         .profile-name {
             font-size: 24px;
             font-weight: 700;
             color: #ffffff;
             margin-bottom: 8px;
         }

         .profile-balance {
             font-size: 32px;
             font-weight: 800;
             background: linear-gradient(135deg, #00d4aa 0%, #00a86b 100%);
             -webkit-background-clip: text;
             -webkit-text-fill-color: transparent;
             background-clip: text;
             margin-bottom: 20px;
         }

         .profile-stats {
             display: grid;
             grid-template-columns: repeat(2, 1fr);
             gap: 16px;
             margin-top: 20px;
         }

         .stat-item {
             text-align: center;
             padding: 16px;
             background: rgba(255, 255, 255, 0.05);
             border-radius: 12px;
             border: 1px solid rgba(255, 255, 255, 0.1);
         }

         .stat-value {
             font-size: 20px;
             font-weight: 700;
             color: #ffffff;
             margin-bottom: 4px;
         }

         .stat-label {
             font-size: 14px;
             color: var(--tg-theme-hint-color, #8e8e93);
         }

         @media (max-width: 480px) {
             .products-grid {
                 grid-template-columns: 1fr;
             }
             
             .container {
                 padding: 12px;
             }
         }
    </style>
</head>
<body>
    <!-- Premium Animated Background -->
    <div class="premium-background"></div>
    <div class="neural-network"></div>
    
    <!-- Floating Particles -->
    <div class="floating-particles" id="particles"></div>
    
    <!-- Floating Tech Elements -->
    <div class="floating-brands">
        <div class="brand-logo" style="top: 10%; left: 5%; animation-delay: 0s;">◆</div>
        <div class="brand-logo" style="top: 20%; right: 10%; animation-delay: 2s;">▲</div>
        <div class="brand-logo" style="top: 60%; left: 8%; animation-delay: 4s;">●</div>
        <div class="brand-logo" style="top: 80%; right: 5%; animation-delay: 6s;">■</div>
        <div class="brand-logo" style="top: 40%; right: 15%; animation-delay: 1s;">▼</div>
        <div class="brand-logo" style="top: 70%; left: 12%; animation-delay: 3s;">◇</div>
    </div>
    
    <div class="app">
        <div class="header">
            <div class="header-content">
                <h1>🛍️ Shop</h1>
                <div class="balance" id="userBalance">Loading...</div>
            </div>
            
            <div class="tabs">
                <div class="tab active" data-tab="shop">
                    <span>🛒 Shop</span>
                </div>
                <div class="tab" data-tab="basket">
                    <span>🛍️ Basket</span>
                </div>
                <div class="tab" data-tab="profile">
                    <span>👤 Profile</span>
                </div>
            </div>
        </div>
        
        <!-- City Icon Style Selector -->
        <div style="
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 12px;
            padding: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        ">
            <div style="
                font-size: 12px;
                color: #ffffff;
                margin-bottom: 8px;
                text-align: center;
                font-weight: 600;
            ">City Icon Style</div>
            <div style="
                display: flex;
                gap: 8px;
            ">
                <button onclick="updateCityIconStyle(1)" style="
                    width: 32px;
                    height: 32px;
                    border: none;
                    border-radius: 6px;
                    background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%);
                    color: white;
                    font-size: 12px;
                    font-weight: bold;
                    cursor: pointer;
                    transition: all 0.2s ease;
                " title="Modern Skyscraper">1</button>
                <button onclick="updateCityIconStyle(2)" style="
                    width: 32px;
                    height: 32px;
                    border: none;
                    border-radius: 6px;
                    background: linear-gradient(135deg, #00ff88 0%, #ff0088 100%);
                    color: white;
                    font-size: 12px;
                    font-weight: bold;
                    cursor: pointer;
                    transition: all 0.2s ease;
                " title="Cyberpunk Neon">2</button>
                <button onclick="updateCityIconStyle(3)" style="
                    width: 32px;
                    height: 32px;
                    border: none;
                    border-radius: 6px;
                    background: linear-gradient(135deg, var(--accent-blue) 0%, #ffffff 100%);
                    color: white;
                    font-size: 12px;
                    font-weight: bold;
                    cursor: pointer;
                    transition: all 0.2s ease;
                " title="Minimalist">3</button>
                <button onclick="updateCityIconStyle(4)" style="
                    width: 32px;
                    height: 32px;
                    border: none;
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(88, 166, 255, 0.8) 100%);
                    color: #000;
                    font-size: 12px;
                    font-weight: bold;
                    cursor: pointer;
                    transition: all 0.2s ease;
                " title="Fantasy Crystal">4</button>
            </div>
        </div>

        <div class="content">
            <!-- Shop Tab -->
            <div class="tab-content active" id="shop-content">
                <!-- City Selection -->
                <div class="selection-step" id="cityStep">
                    <h3 class="step-title">
                        <div id="titleCityIcon" class="city-icon-3d-style1" style="display: inline-block; width: 32px; height: 32px; margin-right: 12px; vertical-align: middle;">
                            <div class="city-building-style1"></div>
                            <div class="city-building-style1"></div>
                            <div class="city-building-style1"></div>
                            <div class="city-building-style1"></div>
                        </div>
                        Choose Your City
                    </h3>
                    <div class="button-grid" id="cityButtons">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            <p>Loading cities...</p>
                        </div>
                    </div>
                </div>

                <!-- District Selection -->
                <div class="selection-step" id="districtStep" style="display: none;">
                    <div class="step-header">
                        <button class="back-btn" id="backToCity">← Back</button>
                        <h3 class="step-title">🏘️ Choose District</h3>
                    </div>
                    <div class="button-grid" id="districtButtons">
                    </div>
                </div>

                <!-- Products Display -->
                <div class="selection-step" id="productsStep" style="display: none;">
                    <div class="step-header">
                        <button class="back-btn" id="backToDistrict">← Back</button>
                        <h3 class="step-title">🛍️ Products</h3>
                        <div class="location-info" id="locationInfo"></div>
                    </div>
                    <div id="productsContainer">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            <p>Loading products...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Basket Tab -->
            <div class="tab-content" id="basket-content">
                <div id="basketContainer">
                    <div class="empty-state">
                        <div class="empty-state-emoji">🛒</div>
                        <h3>Your basket is empty</h3>
                        <p>Add some products to get started</p>
                    </div>
                </div>
            </div>

            <!-- Profile Tab -->
            <div class="tab-content" id="profile-content">
                <div id="profileContainer">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Loading profile...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button class="basket-fab" id="basketFab">
        🛒
        <span class="basket-badge" id="basketBadge">0</span>
    </button>

    <script>
        // Initialize Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // Create subtle floating particles
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 8;

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 20 + 's';
                particle.style.animationDuration = (15 + Math.random() * 15) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // Create particles on load
        createParticles();

        // Add premium interaction effects
        function addPremiumEffects() {
            // Add ripple effect to buttons
            document.addEventListener('click', function(e) {
                if (e.target.matches('.location-btn, .btn, .tab')) {
                    const ripple = document.createElement('span');
                    const rect = e.target.getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    const x = e.clientX - rect.left - size / 2;
                    const y = e.clientY - rect.top - size / 2;
                    
                    ripple.style.width = ripple.style.height = size + 'px';
                    ripple.style.left = x + 'px';
                    ripple.style.top = y + 'px';
                    ripple.classList.add('ripple');
                    
                    e.target.style.position = 'relative';
                    e.target.style.overflow = 'hidden';
                    e.target.appendChild(ripple);
                    
                    setTimeout(() => {
                        ripple.remove();
                    }, 600);
                }
            });
        }

        // Initialize premium effects
        addPremiumEffects();

        // Get user data from Telegram
        const user = tg.initDataUnsafe.user;
        const userId = user ? user.id : null;

        // API base URL
        const API_BASE = '/api';

        // Global state
        let currentCity = '';
        let currentDistrict = '';
        let basketItems = [];
        let userBalance = 0;
        
        // City icon style selector (change this number 1-4 to switch styles)
        let currentCityIconStyle = 1; // 1=Modern, 2=Cyberpunk, 3=Minimalist, 4=Fantasy
        
        // Function to update city icon style
        function updateCityIconStyle(styleNumber) {
            currentCityIconStyle = styleNumber;
            
            // Update title icon
            const titleIcon = document.getElementById('titleCityIcon');
            if (titleIcon) {
                titleIcon.className = `city-icon-3d-style${styleNumber}`;
                titleIcon.innerHTML = '';
                
                const buildingCount = styleNumber === 3 ? 3 : 4;
                for (let i = 1; i <= buildingCount; i++) {
                    const building = document.createElement('div');
                    building.className = `city-building-style${styleNumber}`;
                    titleIcon.appendChild(building);
                }
            }
            
            // Reload cities to update their icons
            if (currentCity === '') {
                loadCities();
            }
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.dataset.tab;
                switchTab(targetTab);
            });
        });

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`${tabName}-content`).classList.add('active');

            // Load content based on tab
            switch(tabName) {
                case 'shop':
                    loadCities();
                    break;
                case 'basket':
                    loadBasket();
                    break;
                case 'profile':
                    loadProfile();
                    break;
            }
        }

        // API calls
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Telegram-Init-Data': tg.initData,
                        ...options.headers
                    }
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }

        // Load user balance
        async function loadUserBalance() {
            try {
                const data = await apiCall('/user/balance');
                userBalance = data.balance;
                document.getElementById('userBalance').textContent = `Balance: €${userBalance}`;
            } catch (error) {
                document.getElementById('userBalance').textContent = 'Balance: Error';
            }
        }

        // Load cities with button interface
        async function loadCities() {
            try {
                const data = await apiCall('/cities');
                const cityButtons = document.getElementById('cityButtons');
                
                if (data.cities.length === 0) {
                    cityButtons.innerHTML = '<p style="text-align: center; color: var(--tg-theme-hint-color, #8e8e93);">No cities available</p>';
                    return;
                }
                
                cityButtons.innerHTML = '';
                data.cities.forEach(city => {
                    const button = document.createElement('button');
                    button.className = 'location-btn';
                    
                    // Create 3D animated city icon with dynamic style
                    const cityIcon = document.createElement('div');
                    cityIcon.className = `city-icon-3d-style${currentCityIconStyle}`;
                    
                    // Create buildings with dynamic style
                    const buildingCount = currentCityIconStyle === 3 ? 3 : 4; // Style 3 has 3 buildings
                    for (let i = 1; i <= buildingCount; i++) {
                        const building = document.createElement('div');
                        building.className = `city-building-style${currentCityIconStyle}`;
                        cityIcon.appendChild(building);
                    }
                    
                    // Create city name span
                    const cityName = document.createElement('span');
                    cityName.textContent = city.name;
                    
                    button.appendChild(cityIcon);
                    button.appendChild(cityName);
                    button.onclick = () => handleCitySelection(city.id, city.name);
                    cityButtons.appendChild(button);
                });

                // Show city step, hide others
                showStep('city');
            } catch (error) {
                document.getElementById('cityButtons').innerHTML = '<p style="text-align: center; color: #ff4444;">Failed to load cities</p>';
                showError('Failed to load cities');
            }
        }

        // Handle city selection
        async function handleCitySelection(cityId, cityName) {
            currentCity = cityId;
            currentDistrict = '';
            
            try {
                const data = await apiCall(`/districts/${cityId}`);
                const districtButtons = document.getElementById('districtButtons');
                
                if (data.districts.length === 0) {
                    districtButtons.innerHTML = '<p style="text-align: center; color: var(--tg-theme-hint-color, #8e8e93);">No districts available for this city</p>';
                    showStep('district');
                    return;
                }
                
                districtButtons.innerHTML = '';
                data.districts.forEach(district => {
                    const button = document.createElement('button');
                    button.className = 'location-btn';
                    button.textContent = `🏘️ ${district.name}`;
                    button.onclick = () => handleDistrictSelection(district.id, district.name, cityName);
                    districtButtons.appendChild(button);
                });
                
                showStep('district');
            } catch (error) {
                showError('Failed to load districts');
            }
        }

        // Handle district selection
        async function handleDistrictSelection(districtId, districtName, cityName) {
            currentDistrict = districtId;
            
            // Update location info
            document.getElementById('locationInfo').innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div class="location-pin-3d" style="
                        width: 20px; 
                        height: 20px; 
                        background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%);
                        border-radius: 50% 50% 50% 0;
                        transform: rotate(-45deg);
                        position: relative;
                        animation: pinPulse 2s ease-in-out infinite;
                        box-shadow: 0 2px 8px rgba(88, 166, 255, 0.4);
                    ">
                        <div style="
                            position: absolute;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%) rotate(45deg);
                            width: 6px;
                            height: 6px;
                            background: white;
                            border-radius: 50%;
                        "></div>
                    </div>
                    <span>${cityName} → ${districtName}</span>
                </div>
            `;
            
            showStep('products');
            await loadProducts();
        }

        // Show specific step and hide others
        function showStep(step) {
            const steps = ['city', 'district', 'products'];
            steps.forEach(s => {
                const element = document.getElementById(`${s}Step`);
                if (element) {
                    element.style.display = s === step ? 'block' : 'none';
                }
            });
        }

        // Back button handlers
        document.getElementById('backToCity').addEventListener('click', () => {
            showStep('city');
            currentCity = '';
            currentDistrict = '';
        });

        document.getElementById('backToDistrict').addEventListener('click', () => {
            showStep('district');
            currentDistrict = '';
        });

        // Load products
        async function loadProducts() {
            const container = document.getElementById('productsContainer');
            container.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading premium products...</p>
                </div>
            `;

            try {
                const data = await apiCall(`/products/${currentCity}/${currentDistrict}`);
                displayProducts(data.products);
            } catch (error) {
                showError('Failed to load products');
            }
        }

        // Handle Buy Now button
        async function handleBuyNow(productId) {
            try {
                console.log('Starting payment process for product:', productId);
                // Show currency selection modal
                await showCurrencySelection(productId);
            } catch (error) {
                console.error('Error in handleBuyNow:', error);
                showError('Failed to start payment process: ' + error.message);
            }
        }

        // Show currency selection modal
        async function showCurrencySelection(productId) {
            try {
                console.log('Loading currencies for product:', productId);
                const currencyData = await apiCall('/payment/currencies');
                console.log('Currency data received:', currencyData);
                
                if (!currencyData.currencies) {
                    throw new Error('No currencies received from server');
                }
                
                const currencies = currencyData.currencies;

                // Create modal HTML
                const modalHTML = `
                    <div class="payment-modal">
                        <div class="payment-modal-content">
                            <div class="payment-modal-header">
                                <h3>Select Payment Currency</h3>
                                <button class="close-modal" onclick="closePaymentModal()">×</button>
                            </div>
                            <div class="currency-list">
                                ${currencies.map(currency => `
                                    <button class="currency-btn" onclick="createPayment('${productId}', 'single', '${currency.code}')">
                                        <span class="currency-symbol">${currency.symbol}</span>
                                        <span class="currency-name">${currency.name}</span>
                                        ${currency.network ? `<span class="currency-network">${currency.network}</span>` : ''}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);
            } catch (error) {
                console.error('Error in showCurrencySelection:', error);
                showError('Failed to load payment currencies: ' + error.message);
            }
        }

        // Create payment invoice
        async function createPayment(productId, type, currency) {
            try {
                console.log('Creating payment:', { productId, type, currency });
                closePaymentModal();
                
                // Show loading state
                const loadingHTML = `
                    <div class="payment-modal">
                        <div class="payment-modal-content">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                                <p>Creating payment invoice...</p>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', loadingHTML);
                
                const paymentData = await apiCall('/payment/create', {
                    method: 'POST',
                    body: JSON.stringify({
                        type: type,
                        product_id: productId,
                        currency: currency
                    })
                });

                console.log('Payment response:', paymentData);
                closePaymentModal(); // Close loading modal

                if (paymentData.success) {
                    showPaymentInvoice(paymentData);
                } else {
                    showError(paymentData.error || 'Payment creation failed');
                }
            } catch (error) {
                console.error('Error in createPayment:', error);
                closePaymentModal(); // Close loading modal
                showError('Failed to create payment: ' + error.message);
            }
        }

        // Show payment invoice modal
        function showPaymentInvoice(paymentData) {
            const expiryDate = paymentData.expiration_estimate_date ? 
                new Date(paymentData.expiration_estimate_date).toLocaleString() : 'N/A';

            const invoiceHTML = `
                <div class="payment-modal invoice-modal">
                    <div class="payment-modal-content">
                        <div class="payment-modal-header">
                            <h3>💳 Payment Invoice</h3>
                            <button class="close-modal" onclick="closePaymentModal()">×</button>
                        </div>
                        <div class="invoice-content">
                            <div class="invoice-section">
                                <h4>Payment Details</h4>
                                <div class="payment-info">
                                    <div class="payment-row">
                                        <span>Amount:</span>
                                        <span class="payment-amount">${paymentData.pay_amount} ${paymentData.pay_currency}</span>
                                    </div>
                                    <div class="payment-row">
                                        <span>EUR Value:</span>
                                        <span>€${paymentData.price_amount}</span>
                                    </div>
                                    <div class="payment-row">
                                        <span>Payment ID:</span>
                                        <span class="payment-id">${paymentData.payment_id}</span>
                                    </div>
                                    <div class="payment-row">
                                        <span>Expires:</span>
                                        <span>${expiryDate}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="invoice-section">
                                <h4>Wallet Address</h4>
                                <div class="wallet-address-container">
                                    <div class="wallet-address" id="walletAddress">${paymentData.pay_address}</div>
                                    <button class="copy-btn" onclick="copyToClipboard('walletAddress')">📋 Copy</button>
                                </div>
                            </div>

                            <div class="invoice-section">
                                <div class="payment-instructions">
                                    <h4>⚠️ Payment Instructions</h4>
                                    <ul>
                                        <li>Send exactly <strong>${paymentData.pay_amount} ${paymentData.pay_currency}</strong> to the address above</li>
                                        <li>Payment will be automatically confirmed when received</li>
                                        <li>Do not send from an exchange - use a personal wallet</li>
                                        <li>Your order will be processed after confirmation</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', invoiceHTML);
        }

        // Copy to clipboard function
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                // Show success feedback
                const copyBtn = element.nextElementSibling;
                const originalText = copyBtn.textContent;
                copyBtn.textContent = '✅ Copied!';
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                }, 2000);
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                const copyBtn = element.nextElementSibling;
                const originalText = copyBtn.textContent;
                copyBtn.textContent = '✅ Copied!';
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                }, 2000);
            });
        }

        // Close payment modal
        function closePaymentModal() {
            const modal = document.querySelector('.payment-modal');
            if (modal) {
                modal.remove();
            }
        }

        // Display products
        function displayProducts(products) {
            const container = document.getElementById('productsContainer');
            
            if (products.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-emoji">📦</div>
                        <h3>No products available</h3>
                        <p>No products found in this location</p>
                    </div>
                `;
                return;
            }

            const productsHTML = products.map(product => `
                <div class="product-card">
                    <div class="product-header">
                        <span class="product-emoji">${product.emoji}</span>
                        <h3 class="product-title">${product.type} - ${product.size}</h3>
                    </div>
                    <div class="product-info">
                        <div class="product-location" style="display: flex; align-items: center; gap: 6px;">
                            <div style="
                                width: 14px; 
                                height: 14px; 
                                background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%);
                                border-radius: 50% 50% 50% 0;
                                transform: rotate(-45deg);
                                position: relative;
                                animation: pinPulse 3s ease-in-out infinite;
                                flex-shrink: 0;
                            ">
                                <div style="
                                    position: absolute;
                                    top: 50%;
                                    left: 50%;
                                    transform: translate(-50%, -50%) rotate(45deg);
                                    width: 4px;
                                    height: 4px;
                                    background: white;
                                    border-radius: 50%;
                                "></div>
                            </div>
                            <span>${product.city} - ${product.district}</span>
                        </div>
                        <div class="product-price">€${product.price}</div>
                        <div class="product-stock">
                            <span class="stock-indicator"></span>
                            ${product.stock} available
                        </div>
                    </div>
                    <div class="product-actions">
                        <button class="btn btn-secondary" onclick="addToBasket(${product.id}, '${product.type}', '${product.size}', ${product.price})">
                            Add to Basket
                        </button>
                        <button class="btn btn-primary" onclick="handleBuyNow(${product.id})">
                            Buy Now
                        </button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `<div class="products-grid">${productsHTML}</div>`;
        }

        // Add to basket
        async function addToBasket(productId, type, size, price) {
            try {
                await apiCall('/basket/add', {
                    method: 'POST',
                    body: JSON.stringify({
                        product_id: productId,
                        type: type,
                        size: size,
                        price: price
                    })
                });

                updateBasketBadge();
                tg.showAlert('Product added to basket!');
            } catch (error) {
                tg.showAlert('Failed to add product to basket');
            }
        }

        // Buy now
        async function buyNow(productId) {
            try {
                const data = await apiCall('/payment/create', {
                    method: 'POST',
                    body: JSON.stringify({
                        product_id: productId,
                        type: 'single'
                    })
                });

                if (data.payment_url) {
                    tg.openLink(data.payment_url);
                } else {
                    tg.showAlert('Payment creation failed');
                }
            } catch (error) {
                tg.showAlert('Failed to create payment');
            }
        }

        // Load basket
        async function loadBasket() {
            try {
                const data = await apiCall('/basket');
                displayBasket(data.items, data.total);
            } catch (error) {
                showError('Failed to load basket');
            }
        }

        // Display basket
        function displayBasket(items, total) {
            const container = document.getElementById('basketContainer');
            
            if (items.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-emoji">🛒</div>
                        <h3>Your basket is empty</h3>
                        <p>Add some products to get started</p>
                    </div>
                `;
                return;
            }

            const itemsHTML = items.map(item => `
                <div class="product-card">
                    <div class="product-header">
                        <span class="product-emoji">${item.emoji}</span>
                        <h3 class="product-title">${item.type} - ${item.size}</h3>
                    </div>
                    <div class="product-info">
                        <div class="product-location" style="display: flex; align-items: center; gap: 6px;">
                            <div style="
                                width: 14px; 
                                height: 14px; 
                                background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%);
                                border-radius: 50% 50% 50% 0;
                                transform: rotate(-45deg);
                                position: relative;
                                animation: pinPulse 3s ease-in-out infinite;
                                flex-shrink: 0;
                            ">
                                <div style="
                                    position: absolute;
                                    top: 50%;
                                    left: 50%;
                                    transform: translate(-50%, -50%) rotate(45deg);
                                    width: 4px;
                                    height: 4px;
                                    background: white;
                                    border-radius: 50%;
                                "></div>
                            </div>
                            <span>${item.city} - ${item.district}</span>
                        </div>
                        <div class="product-price">€${item.price}</div>
                    </div>
                    <div class="product-actions">
                        <button class="btn btn-secondary" onclick="removeFromBasket(${item.id})">
                            🗑️ Remove
                        </button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `
                <div class="products-grid">${itemsHTML}</div>
                <div class="profile-card" style="margin-top: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <span style="font-size: 18px; color: var(--tg-theme-hint-color, #8e8e93);">Total:</span>
                        <span style="font-size: 28px; font-weight: 800; background: linear-gradient(135deg, #00d4aa 0%, #00a86b 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">€${total}</span>
                    </div>
                    <button class="btn btn-primary" style="width: 100%; padding: 16px;" onclick="checkoutBasket()">
                        💳 Checkout Basket
                    </button>
                </div>
            `;
        }

        // Remove from basket
        async function removeFromBasket(itemId) {
            try {
                await apiCall('/basket/remove', {
                    method: 'POST',
                    body: JSON.stringify({ item_id: itemId })
                });

                loadBasket();
                updateBasketBadge();
                tg.showAlert('Item removed from basket');
            } catch (error) {
                tg.showAlert('Failed to remove item from basket');
            }
        }

        // Checkout basket
        async function checkoutBasket() {
            try {
                const data = await apiCall('/payment/create', {
                    method: 'POST',
                    body: JSON.stringify({ type: 'basket' })
                });

                if (data.payment_url) {
                    tg.openLink(data.payment_url);
                } else {
                    tg.showAlert('Payment creation failed');
                }
            } catch (error) {
                tg.showAlert('Failed to create payment');
            }
        }

        // Load profile
        async function loadProfile() {
            try {
                const data = await apiCall('/user/profile');
                displayProfile(data);
            } catch (error) {
                showError('Failed to load profile');
            }
        }

        // Display profile
        function displayProfile(profile) {
            const container = document.getElementById('profileContainer');
            const firstLetter = (profile.first_name || profile.username || 'U').charAt(0).toUpperCase();
            
            container.innerHTML = `
                <div class="profile-card">
                    <div class="profile-avatar">${firstLetter}</div>
                    <div class="profile-info">
                        <div class="profile-name">${profile.first_name || profile.username || 'User'}</div>
                        <div class="profile-balance">€${profile.balance}</div>
                        
                        <div class="profile-stats">
                            <div class="stat-item">
                                <div class="stat-value">${profile.total_purchases}</div>
                                <div class="stat-label">Orders</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">€${profile.total_spent || 0}</div>
                                <div class="stat-label">Total Spent</div>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary" onclick="refillBalance()" style="width: 100%; margin-top: 24px;">
                            💰 Refill Balance
                        </button>
                    </div>
                </div>
                
                <div class="profile-card">
                    <h3 style="color: #ffffff; margin-bottom: 16px;">📊 Account Details</h3>
                    <div style="display: grid; gap: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--tg-theme-hint-color, #8e8e93);">User ID:</span>
                            <span style="color: #ffffff; font-weight: 600;">${profile.user_id}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--tg-theme-hint-color, #8e8e93);">Username:</span>
                            <span style="color: #ffffff; font-weight: 600;">@${profile.username || 'N/A'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--tg-theme-hint-color, #8e8e93);">Member Since:</span>
                            <span style="color: #ffffff; font-weight: 600;">${profile.joined_date}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // Refill balance
        async function refillBalance() {
            const amount = prompt('Enter amount to refill (EUR):');
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                try {
                    const data = await apiCall('/payment/refill', {
                        method: 'POST',
                        body: JSON.stringify({ amount: parseFloat(amount) })
                    });

                    if (data.payment_url) {
                        tg.openLink(data.payment_url);
                    } else {
                        tg.showAlert('Payment creation failed');
                    }
                } catch (error) {
                    tg.showAlert('Failed to create refill payment');
                }
            }
        }

        // Update basket badge
        async function updateBasketBadge() {
            try {
                const data = await apiCall('/basket/count');
                const badge = document.getElementById('basketBadge');
                const fab = document.getElementById('basketFab');
                
                if (data.count > 0) {
                    badge.textContent = data.count;
                    fab.style.display = 'flex';
                } else {
                    fab.style.display = 'none';
                }
            } catch (error) {
                console.error('Failed to update basket badge');
            }
        }

        // Show error
        function showError(message) {
            const container = document.getElementById('productsContainer');
            container.innerHTML = `
                <div class="error">
                    <div style="font-size: 48px; margin-bottom: 16px;">⚠️</div>
                    <h3 style="color: #ff3b30; margin-bottom: 8px;">Error</h3>
                    <p>${message}</p>
                </div>
            `;
        }

        // Clear products and reset to city selection
        function clearProducts() {
            const container = document.getElementById('productsContainer');
            container.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Select a location to view products...</p>
                </div>
            `;
            showStep('city');
            currentCity = '';
            currentDistrict = '';
        }

        // Basket FAB click
        document.getElementById('basketFab').addEventListener('click', () => {
            switchTab('basket');
        });

        // Initialize app
        async function init() {
            if (!userId) {
                tg.showAlert('User authentication failed');
                return;
            }

            await loadUserBalance();
            await updateBasketBadge();
            await loadCities();
        }

        // Start the app
        init();

        // Set up main button for payments
        tg.MainButton.setText('Continue in Telegram');
        tg.MainButton.show();
        tg.MainButton.onClick(() => {
            tg.close();
        });
    </script>
</body>
</html>
